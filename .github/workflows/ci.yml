name: CI
on:
  push:
    branches: ['**']
  pull_request:
    types: [opened, synchronize, reopened]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  format:
    name: "🧹 Format"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v5
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: "Check formatting ✨"
        run: pnpm run format:check --if-present || pnpm run format --if-present

  lint:
    name: "🔎 Lint"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v5
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: "Run linting 🧪"
        run: pnpm run lint --if-present

  typecheck:
    name: "🧠 Typecheck"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v5
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: "Type checking 🧩"
        run: pnpm run typecheck --if-present

  build:
    name: "🛠️ Build"
    runs-on: ubuntu-latest
    needs: [format, lint, typecheck]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v5
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: "Building project 🏗️"
        run: pnpm run build --if-present
      - name: "Upload build artifacts"
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            dist/
            build/
            .next/
          retention-days: 7
          if-no-files-found: ignore